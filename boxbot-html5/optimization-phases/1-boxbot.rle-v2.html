<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>BoxBot</title>
    <script type="text/javascript">
      // BoxBot
      //
      // Copyright (c) 2014 Gabor Bata
      //
      // Permission is hereby granted, free of charge, to any person
      // obtaining a copy of this software and associated documentation files
      // (the "Software"), to deal in the Software without restriction,
      // including without limitation the rights to use, copy, modify, merge,
      // publish, distribute, sublicense, and/or sell copies of the Software,
      // and to permit persons to whom the Software is furnished to do so,
      // subject to the following conditions:
      //
      // The above copyright notice and this permission notice shall be
      // included in all copies or substantial portions of the Software.
      //
      // THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
      // EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
      // MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
      // NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
      // BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
      // ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
      // CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
      // SOFTWARE.

      var OUTER_FLOOR = 0;
      var FLOOR = 1;
      var GOAL = 2;
      var PLAYER = 4;
      var BOX = 5;
      var BOX_ON_GOAL = 6;
      var PLAYER_SHADOW = 7;
      var SHADOW = 8;
      var SHADOW_SHIFT = 4;
      var TABLE_WIDTH = 14;
      var TABLE_HEIGHT = 12;
      var IMAGE_SCALE = 2;
      var IMAGE_SIZE = 16;
      var BLOCK_SIZE = IMAGE_SIZE * IMAGE_SCALE;

      var LEVEL_DATA = decompress(
        "RlpDk*3%!N!3!$(7+ -#~  lk(1!!%$1!&\"!16.bel/4k(1!N1#&#\"1!!$!1)!1!!(2)#gl/4/4p!$(1w!1\"!!\"2+#sb. 6. #\"#%#1!!$!1"+
        "\"N2(#m/l~   -3+!3!\"&&%$3+abm/lt )2(O1\"%%\"1!O1!$!!2(#m/lf )2(O1)!1(!\"(#+o!#$\"1w!1!N1\"!(2)#f +#9E#5%J#3+!3O\""+
        "$\"#9%#i, 6.bfl.n!!)3+!3!\"\"#8+o!N2(#A/lfb. 6*b!#K)4!%j) z%m!#)y\"\"!6)o$!*3m/lgb.Bi*o$%\"m*y!&6* z%D#*bm/lrlk)#5"+
        "\"j5$%89M1D/4/lg *1O\"1!%#\"1)K9#!O1%!$!1j2*#hb. 6+l(!3\"&j3!%#m9Am, ,#slp\"$#k(1N!1!%\"!1!!(2)#vb, (658!#3!O\"!3!"+
        "\"m!3#%#\"89$!i,bf ,#9)75(#\"3#!z3mN3!!$!%#3mm, ,#e )2(O)#*C!#$\"#*Cw\"#*4H\"L*6.brb.y$i5z3#%\"&#!3!%\"&!!3!M3)!2+"+
        "#Wl/4p%$#p\"%(#9#\"%m3!\"6L#,!L*6.bUlk(1!$!!1D%##9#\"%m5%\"P569)K,om/lW ,3#m!i)y8!%m)y!\"$\"j)n8!%(#*y\"!\"!q,#~  "+
        "lk*3!!\"&\"!3N%!$3(!)#+bt ,#9\"!\"7, 6!#9#!N1w#1!!$#.btl/416#5$%85P!#9\"\"j, ,#tlp!\"2(#m#5%%m9*!#9#%P1\"$\"#.bgb."+
        " 6,o%P3!!%$%!3!E3(\"i+ +#r +1)!1!!\"%*#)n&\"%)!L#$\"%6*n!!*#+l~ * ,3F(!3!%&%#!3!#$(!3!!\"i+ +#~ ( ,3#)\"$##*y!88*y"+
        "N!8*46* .#~ )l,l!$#5!%85\"!89#\"D2*#s -3!\"$\"!!3N%!!3#&#&(3*!#9*!#5!)#,lg ,#5\"j5!%\"\"#,o%&(3!%$(!3+a -#s )2(O1)"+
        "K5F\"#5(%$#,o!#!x#!7.btb, (65(%$#9(D#9)!2+#u *1z1!$m9#!8#5%&!1!G1!72*#hlk2(#8#5!%m9$#&D3!!&\"!ao)!2+#Xb,o$m9\"!%75"+
        "!8#+o!(3Hm9*!#9\"!i,bhl/4x#$\"!x#\"\"%#1w!1)!2+#tlp!i+o!\"!!3$(%!!3j\"ao\"m2*#sl/4k)#5\"\"&!3#w$!3(!)3j.beb.Bi5!\""+
        "%i*n7N37!%$3G!85!)#,lelk*3)!A#*y\"&\"%&!#*nm%!!3#(i,bvl+b!!3(!\"\"%##*y%$#!8*n%\"\"(!3m#!a -#rb. 6.y#%##9#\"\"A5&"+
        "\"85H##9)!2+#do0 #\"*#9(\"m5Pi*Bw!$#*o!!%8, (6.bc -3m#7*n(!%m*y!%#%7* 6AL#D#!a -#sb. z1z(3!)%!3!)\"!3#!$i,br -3"+
        "\"\"!$\"\"3!!(8+l!)L#,!L#*!8*y!+#*lI |1|#- #|2|#- |3|#+ #|4| #!!#|5|, #!|6|#(!#|7|!\"#|8|%!#|9|, #|a|!#+|b| *#|i|!"+
        "(#|j|(!#|k|/ #!!|l| )#|m|!!#|n| ##|o| (#|p|/ #|q|#, |w|!%%|x|#. |y| #!|z|#(!|A|$!#|B| #(|C| #)|D|\"!#|E|#)!|F|#!\""+
        "|G|#\"!|H|#!%|J|##!|K|!##|L|#* |M|#!!(|N|!%!|O|#!!|P|#!#");
      var IMAGE_DATA = decompress(
        "* *!\"/aic*!c!(\"!c*!c+\",a,i\")a,i\")a!*\"i\")a!*\"i\")b,!(\"+ -\".a a/a a- (g (!\"+ "+
        ")\"  )\"7j9\"+!\"\"08+8!!6hhhh\" 0g0g0g0g0g0g0g0g0g0g0g0!6\"4j9\"+!\"\"08+8!!6\"- -121212121212!- 5!-212121212121 "+
        "-!. .8(! (!, \"(!e!,b!8\"!,d3\" .\" 3\" (8)! 3\"(! \"(8\"3\"!8\"!3\"3\"3\"3\"\"8\"\"3\"8(\"!d3\" )\" d 3\" .! 3\"("+
        "!, \"8f!,b!d!,dd  .\" |0|!!\" !|1|! +\"|2| !+ |3|!( |8|!  |9|!!\"|a| !\"|b| \"\"|c|\"/ |d| (\"|e| \"!|f|\"\"!|g|!"+
        "\" |h|\"( |i|!\"!|j| \" " );

      var IMAGE_INDEX = 3;
      var IMAGE_PALETTE = [
          // floor: outer
          [ 'rgba(33, 40, 92, 1)', 'rgba(25, 32, 76, 1)', 'rgba(48, 51, 120, 1)', 2 ],
          // floor: inner
          [ 'rgba(92, 60, 32, 1)', 'rgba(76, 48, 24, 1)', 'rgba(120, 88, 48, 1)',   2 ],
          // floor: goal
          [ 'rgba(116, 6, 12, 1)', 'rgba(100, 3, 5, 1)', 'rgba(142, 22, 24, 1)',   2 ],
          // wall
          [ 'rgba(162, 155, 121, 1)', 'rgba(206, 196, 145, 1)', 'rgba(127, 117, 67, 1)',  3 ],
          // player
          [ 'rgba(0 ,0 ,0 ,0)', 'rgba(192, 192, 192, 1)', 'rgba(128, 128, 128, 1)', 0 ],
          // box
          [ 'rgba(196 ,168 ,100 ,1)', 'rgba(168, 132, 72, 1)', 'rgba(111, 78, 42, 1)', 1 ],
          // box on goal
          [ 'rgba(196, 120, 101, 1)', 'rgba(168, 84, 73, 1)', 'rgba(111, 44, 43, 1)', 1 ],
          // player shadow
          [ 'rgba(0, 0, 0, 0)', 'rgba(0, 0, 0, 0.3)', 'rgba(0, 0, 0, 0.3)', 0 ],
          // shadow
          [ 'rgba(0, 0, 0, 0.3)', 'rgba(0, 0, 0, 0.3)', 'rgba(0, 0, 0, 0.3)', 1 ]
      ];

      var STATUS_TEXT = 'LEVEL: %s     MOVES: %s     PUSHES: %s';
      var COMPLETED_TEXT = 'LEVEL COMPLETED! PRESS ENTER TO CONTINUE.';

      var GAME_TITLE = 'BOXBOT';
      var GAME_CONTROLS = 'GAME CONTROLS:';
      var GAME_CONTROL_ARROWS = 'ARROW KEYS - MOVE';
      var GAME_CONTROL_RESTART = 'BACKSPACE - RESTART LEVEL';
      var GAME_CONTROL_LEVEL = 'PGUP/PGDN - NEXT/PREVIOUS LEVEL';
      var GAME_CONTROL_START = 'PRESS ANY KEY TO START.';
      var GAME_COPYRIGHT = '(C) 2014 GABOR BATA';

      var LEVEL_NUM = 50;

      var CENTER = TABLE_WIDTH * BLOCK_SIZE / 2;
      var LETTER_SPACING = 19;
      var FONT = 'bold 14px sans-serif';
      var FONT_COLOR = 'rgba(255, 255, 255, 0.4)';
      var TEXT_ALIGN = 'center';

      var COMMAND_UP = 'up';
      var COMMAND_DOWN = 'down';
      var COMMAND_LEFT = 'left';
      var COMMAND_RIGHT = 'right';
      var COMMAND_NEXT = 'next';
      var COMMAND_PREV = 'prev';
      var COMMAND_RESET = 'reset';
      var COMMAND_CONTINUE = 'continue';

      var images;
      var table;
      var context;
      var moves;
      var pushes;
      var levelSolved;
      var level;
      var playerPos;
      var gameStarted;
      var keyPress;

      function sprintf(format) {
          for (var i = 1; i < arguments.length; i++) {
              format = format.replace(/%s/, arguments[i]);
          }
          return format;
      }

      function decompress(k) {
          var i, r = 1, c, d = '', x = k.split("|"), y = x.shift();
          for (i = 0; i < x.length; i += 2) {
              y = y.replace(new RegExp(x[i],'g'), x[i + 1]);
          }
          for (var j = 0; j < y.length; j++) {
              c = y.charCodeAt(j);
              if (c >= 0x27) {
                  r = c - 0x25;
              } else {
                  for (i = 0; i < r; i++) {
                      d += y.charAt(j);
                  }
                  r = 1;
              }
          }
          return d;
      }

      function getData(input, index, output) {
          var counter = 0;
          while (counter < output.length) {
              output[counter] = input.charCodeAt(index * output.length + counter) - 0x20;
              counter++;
          }
      }

      function generateImages() {
          var images = new Array(IMAGE_PALETTE.length); // 9
          var imageData = new Array(IMAGE_SIZE * IMAGE_SIZE);
          for (var i = 0; i < images.length; i++) {
              getData(IMAGE_DATA, IMAGE_PALETTE[i][IMAGE_INDEX], imageData);
              var image = document.createElement('canvas');
              image.width = BLOCK_SIZE;
              image.height = BLOCK_SIZE;
              var imageContext = image.getContext('2d');
              imageContext.clearRect(0, 0, BLOCK_SIZE, BLOCK_SIZE);
              for (var x = 0; x < IMAGE_SIZE; x++) {
                  for (var y = 0; y < IMAGE_SIZE; y++) {
                      imageContext.fillStyle = IMAGE_PALETTE[i][imageData[IMAGE_SIZE * y + x]];
                      imageContext.fillRect(x * IMAGE_SCALE, y * IMAGE_SCALE, IMAGE_SCALE, IMAGE_SCALE);
                  }
              }
              images[i] = image;
          }
          return images;
      }

      function loadLevel() {
          if (level < 0) {
              level = LEVEL_NUM - 1;
          } else if (level > LEVEL_NUM - 1) {
              level = 0;
          }
          moves = 0;
          pushes = 0;
          levelSolved = false;
          getData(LEVEL_DATA, level, table);
          for (var x = 0; x < TABLE_WIDTH; x++) {
              for (var y = 0; y < TABLE_HEIGHT; y++) {
                  if (table[TABLE_WIDTH * y + x] == PLAYER) {
                      table[TABLE_WIDTH * y + x] = FLOOR;
                      playerPos.x = x;
                      playerPos.y = y;
                  }
              }
          }
      }

      function paint() {
          for (var i = 0; i < 3; i++) { // 3 step: draw floor, draw shadows, draw other elements
              for (var x = 0; x < TABLE_WIDTH; x++) {
                  for (var y = 0; y < TABLE_HEIGHT; y++) {
                      if (!gameStarted) {
                          context.drawImage(images[OUTER_FLOOR], x * BLOCK_SIZE, y * BLOCK_SIZE);
                      } else if (i == 0 && table[TABLE_WIDTH * y + x] <= 2) { // draw floor
                          context.drawImage(images[table[TABLE_WIDTH * y + x]], x * BLOCK_SIZE, y * BLOCK_SIZE);
                      } else if (i == 1 && table[TABLE_WIDTH * y + x] > 2) { //draw shadow
                          context.drawImage(images[SHADOW], x * BLOCK_SIZE + SHADOW_SHIFT, y * BLOCK_SIZE + SHADOW_SHIFT);
                      } else if (i == 2 && table[TABLE_WIDTH * y + x] > 2) { //draw other
                          context.drawImage(images[table[TABLE_WIDTH * y + x]], x * BLOCK_SIZE, y * BLOCK_SIZE);
                      }
                  }
              }
              if (i == 1 && gameStarted) { // draw player shadow
                  context.drawImage(images[PLAYER_SHADOW], playerPos.x * BLOCK_SIZE + SHADOW_SHIFT, playerPos.y * BLOCK_SIZE + SHADOW_SHIFT);
              } else if (i == 2 && gameStarted) { // draw player
                  context.drawImage(images[PLAYER], playerPos.x * BLOCK_SIZE, playerPos.y * BLOCK_SIZE);
              }
          }

          // draw text
          context.font = FONT;
          context.fillStyle = FONT_COLOR;
          context.textAlign = TEXT_ALIGN;
          if (!gameStarted) {
              var shift = (TABLE_HEIGHT * BLOCK_SIZE - LETTER_SPACING * 9) / 2;
              context.fillText(GAME_TITLE, CENTER, LETTER_SPACING + shift);
              context.fillText(GAME_CONTROLS, CENTER, LETTER_SPACING * 3 + shift);
              context.fillText(GAME_CONTROL_ARROWS, CENTER, LETTER_SPACING * 4 + shift);
              context.fillText(GAME_CONTROL_RESTART, CENTER, LETTER_SPACING * 5 + shift);
              context.fillText(GAME_CONTROL_LEVEL, CENTER, LETTER_SPACING * 6 + shift);
              context.fillText(GAME_CONTROL_START, CENTER, LETTER_SPACING * 8 + shift);
              context.fillText(GAME_COPYRIGHT, CENTER, TABLE_HEIGHT * BLOCK_SIZE - BLOCK_SIZE / 4);
          } else {
              if (levelSolved) {
                  context.fillText(COMPLETED_TEXT, CENTER, LETTER_SPACING);
              }
              var text = sprintf(STATUS_TEXT, (level + 1), moves, pushes);
              context.fillText(text, CENTER, TABLE_HEIGHT * BLOCK_SIZE - BLOCK_SIZE / 4);
          }
      }

      function handleButtonClick(event) {
        handleCommand(event.target.id);
      }

      function handleKeyReleased() {
        keyPress = false;
      }

      function handleKeyPressed(event) {
          event.preventDefault();
          if (!keyPress) {
              keyPress = true;
              var command = '';
              switch (event.keyCode) {
                case 38: // up
                    command = COMMAND_UP;
                    break;
                case 40: // down
                    command = COMMAND_DOWN;
                    break;
                case 37: // left
                    command = COMMAND_LEFT;
                    break;
                case 39: // right
                    command = COMMAND_RIGHT;
                    break;
                case 33: // page up
                    command = COMMAND_NEXT;
                    break;
                case 34: // page down
                    command = COMMAND_PREV;
                    break;
                case 8: // backspace
                    command = COMMAND_RESET;
                    break;
                case 13: // enter
                    command = COMMAND_CONTINUE;
                    break;
              }
              if (command != '' || !gameStarted) {
                  handleCommand(command);
              }
          }
      }

      function handleCommand(command) {
          if (gameStarted) {
              var direction = { x: 0, y: 0 };
              switch (command) {
                case COMMAND_UP:
                    direction.y = -1;
                    break;
                case COMMAND_DOWN:
                    direction.y = 1;
                    break;
                case COMMAND_LEFT:
                    direction.x = -1;
                    break;
                case COMMAND_RIGHT:
                    direction.x = 1;
                    break;
                case COMMAND_NEXT:
                    level++;
                    loadLevel();
                    break;
                case COMMAND_PREV:
                    level--;
                    loadLevel();
                    break;
                case COMMAND_RESET:
                    loadLevel();
                    break;
                case COMMAND_CONTINUE:
                    if (levelSolved) {
                        level++;
                        loadLevel();
                    }
                    break;
              }
              if ((direction.x != 0 || direction.y != 0) && !levelSolved) {
                  var step = TABLE_WIDTH * (playerPos.y + direction.y) + playerPos.x + direction.x;
                  var nextStep = TABLE_WIDTH * (playerPos.y + direction.y * 2) + playerPos.x + direction.x * 2;
                  if (table[step] == FLOOR || table[step] == GOAL) {
                      playerPos.x += direction.x;
                      playerPos.y += direction.y;
                      moves++;
                  } else if ((table[step] == BOX || table[step] == BOX_ON_GOAL) && (table[nextStep] == FLOOR || table[nextStep] == GOAL)) {
                      table[step] = table[step] == BOX ? FLOOR : GOAL;
                      table[nextStep] = table[nextStep] == FLOOR ? BOX : BOX_ON_GOAL;
                      playerPos.x += direction.x;
                      playerPos.y += direction.y;
                      moves++;
                      pushes++;
                  }
                  var boxesOnGoal = true;
                  for (var i = 0; i < table.length; i++) {
                      if (table[i] == BOX) {
                          boxesOnGoal = false;
                      }
                  }
                  levelSolved = boxesOnGoal;
              }
          } else {
              gameStarted = true;
          }
          paint();
      }

      function addEventListeners() {
          window.addEventListener('keydown', handleKeyPressed, false);
          window.addEventListener('keyup', handleKeyReleased, false);
          var buttons = document.getElementsByTagName('button');
          for (var i = 0; i < buttons.length; i++) {
              buttons[i].addEventListener('click', handleButtonClick, false);
          }
      }

      function init() {
          var canvas = document.getElementById('boxbot-canvas');
          if (canvas != null && !!canvas.getContext) {
              context = canvas.getContext('2d');
              images = generateImages();
              table = new Array(TABLE_WIDTH * TABLE_HEIGHT);
              level = 0;
              playerPos = { x: 0, y: 0 };
              gameStarted = false;
              keyPress = false;
              loadLevel();
              paint();
              addEventListeners();
          } else {
              document.body.appendChild(document.createTextNode('Could not initialize game.'));
          }
      }
    </script>
    <style type="text/css">
      *, *:after, *:before {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      body {
        background-color: black;
        color: white;
        margin: 0;
      }

      [class*='col-'] {
        float: left;
        padding-right: 5px;
      }

      .grid {
        width: 458px;
        margin: 0 auto;
        overflow: hidden;
      }

      .grid:after {
        content: "";
        display: table;
        clear: both;
      }

      .grid-pad {
        padding-left: 5px;
      }

      .col-2-12 {
        width: 16.667%;
      }

      .col-12-12 {
        width: 100%;
      }

      .push-2-12 {
        margin-left: 16.667%;
      }

      .push-4-12 {
        margin-left: 33.334%;
      }

      #boxbot-wrapper {
        display: table;
        position: absolute;
        height: 100%;
        width: 100%;
      }

      #boxbot-container {
        display: table-cell;
        vertical-align: middle;
      }

      #boxbot-container canvas {
        display: block;
        height: 384px;
        margin-bottom: 5px;
        width: 448px;
      }

      #boxbot-container button {
        background-color: black;
        border: 1px solid #555;
        color: #555;
        font-family: sans-serif;
        font-size: 16px;
        margin-bottom: 5px;
        padding: 6px 0;
        width: 100%;
      }
    </style>
  </head>
  <body onload="init();">
    <div id="boxbot-wrapper">
      <div id="boxbot-container">
        <div class="grid grid-pad">
          <div class="col-12-12">
            <canvas id="boxbot-canvas" width="448" height="384"></canvas>
          </div>
        </div>
        <div class="grid grid-pad">
          <div class="col-2-12">
            <button id="prev">Prev.</button>
          </div>
          <div class="col-2-12">
            <button id="next">Next</button>
          </div>
          <div class="col-2-12 push-4-12">
            <button id="up">&#9650;</button>
          </div>
        </div>
        <div class="grid grid-pad">
          <div class="col-2-12">
            <button id="reset">Reset</button>
          </div>
          <div class="col-2-12">
            <button id="enter">Enter</button>
          </div>
          <div class="col-2-12 push-2-12">
            <button id="left">&#9664;</button>
          </div>
          <div class="col-2-12">
            <button id="down">&#9660;</button>
          </div>
          <div class="col-2-12">
            <button id="right">&#9654;</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
