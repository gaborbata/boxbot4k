LEVEL_DATA =
  '              ' +
  '              ' +
  '              ' +
  '   ####       ' +
  '   #"!#       ' +
  '   #!!#####   ' +
  '   #%!!%!!#   ' +
  '   #!$!!!"#   ' +
  '   ########   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!###    ' +
  '    #!!%$#    ' +
  '    #!&"!#    ' +
  '    ##!!!#    ' +
  '     #####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!#      ' +
  '    #!!###    ' +
  '    #!!%!#    ' +
  '    ##&#"#    ' +
  '    #!!$!#    ' +
  '    #!!!!#    ' +
  '    #!!###    ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!#      ' +
  '    #!!#      ' +
  '    #!$###    ' +
  '    #!%%!#    ' +
  '    #"!!"#    ' +
  '    ######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '    #!!!#     ' +
  '    #"#%##    ' +
  '    #!!$!#    ' +
  '    #"!%!#    ' +
  '    ###!!#    ' +
  '      ####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   ########   ' +
  '   #!!!!!!#   ' +
  '   #!"&&%$#   ' +
  '   #!!!!!!#   ' +
  '   #####!!#   ' +
  '       ####   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '      ####    ' +
  '    ###!!#    ' +
  '    #"%%"#    ' +
  '    #!#!!#    ' +
  '    #!$!!#    ' +
  '    ###!!#    ' +
  '      ####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     ####     ' +
  '   ###!!#     ' +
  '   #!!!!#     ' +
  '   #!!!"###   ' +
  '   ###!#$"#   ' +
  '     #!%%!#   ' +
  '     #!!%!#   ' +
  '     #"!###   ' +
  '     ####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ######    ' +
  '   ##!!!!#    ' +
  '   #!%##!##   ' +
  '   #!!!!!!#   ' +
  '   ##!!"$"#   ' +
  '    #%#!###   ' +
  '    #!!!#     ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '   ##!!####   ' +
  '   #!!!!!!#   ' +
  '   #!""#%!#   ' +
  '   ###!!%!#   ' +
  '     ###$!#   ' +
  '       ####   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '      #####   ' +
  '      #!!!#   ' +
  '  #####!#!##  ' +
  '  #!!#!%!!!#  ' +
  '  #!!!%!!#!#  ' +
  '  #!""!#!!!#  ' +
  '  ###$!#####  ' +
  '    #!!#      ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '    #!!!###   ' +
  '  ###$%"!!#   ' +
  '  #!!&#!!!#   ' +
  '  #!!!%"!##   ' +
  '  #####!!#    ' +
  '      ####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   ####       ' +
  '   #!!####    ' +
  '   #!"!!!#    ' +
  '   #!$%%!#    ' +
  '   ##!!###    ' +
  '    #"!#      ' +
  '    #!!#      ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '   ##!!"#     ' +
  '   #!%#"#     ' +
  '   #!!!!##    ' +
  '   ##!#!!#    ' +
  '    #%!$!#    ' +
  '    #!!!##    ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '      #####   ' +
  '      #!!!#   ' +
  '   ####!!!#   ' +
  '   #"&!!!##   ' +
  '   #!%#!!#    ' +
  '   #$!#!!#    ' +
  '   #######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #"$#      ' +
  '    #!!###    ' +
  '    #!%!!#    ' +
  '    #!%"!#    ' +
  '    #!!###    ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     #####    ' +
  '   ###!!!#    ' +
  '   #!%!#!##   ' +
  '   #!#!!"!#   ' +
  '   #!"!!#!#   ' +
  '   ##%#"%!#   ' +
  '    #$!!###   ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #######   ' +
  '    #!!!!"#   ' +
  '    #!###"#   ' +
  '   ##!#!!!#   ' +
  '   #!!#!%!#   ' +
  '   #!!$!%##   ' +
  '   #!!#!!#    ' +
  '   #######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '  ###!!####   ' +
  '  #!!!!#$"#   ' +
  '  #!!!!%%"#   ' +
  '  #!!##!%"#   ' +
  '  #####!!!#   ' +
  '      #####   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '    #!$!###   ' +
  '    #!#!!!#   ' +
  '   ##%"&#!#   ' +
  '   #!%"&!!#   ' +
  '   #!#!!###   ' +
  '   #!!!!#     ' +
  '   ######     ' +
  '              ' +
  '              ' +
  '              ' +
  '   ####       ' +
  '   #!!#       ' +
  '   #%$#       ' +
  '   #"%###     ' +
  '  ##"%!!##    ' +
  '  #!"#!!!##   ' +
  '  #!!!!!!!#   ' +
  '  #####!!!#   ' +
  '      #####   ' +
  '              ' +
  '              ' +
  '              ' +
  '   ####       ' +
  '   #!!###     ' +
  '   #!$!!#     ' +
  '   #"!#%##    ' +
  '   ##"%!!#    ' +
  '   #!%"#!#    ' +
  '   #!#!!!#    ' +
  '   #!!!!##    ' +
  '   ###!!#     ' +
  '     ####     ' +
  '              ' +
  '              ' +
  '              ' +
  '   #######    ' +
  '  ##!!#!!###  ' +
  '  #!%!#!%!!#  ' +
  '  #!!"$"!!!#  ' +
  '  ##%!#!%###  ' +
  '   #!"!"!#    ' +
  '   #######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   ####       ' +
  '   #!!#####   ' +
  '   #!!"&"!#   ' +
  '   #!%!%!$#   ' +
  '   #!!!####   ' +
  '   #####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   #######    ' +
  '   #"!"!"#    ' +
  '   #!!!#!#    ' +
  '   ##!!%!#    ' +
  '    #!%%##    ' +
  '    #!!$#     ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!##     ' +
  '   ##!!!##    ' +
  '   #!$%%!#    ' +
  '   #!#!#!#    ' +
  '   #""!!!#    ' +
  '   #######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     ####     ' +
  '     #!"#     ' +
  '   ###!!##    ' +
  '   #!%%!!#    ' +
  '   #!!!!!#    ' +
  '   ##%#!##    ' +
  '    #"$"#     ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     #####    ' +
  '     #!!!#    ' +
  '   ###%#!##   ' +
  '   #!!%$%!#   ' +
  '   #!#!!!!#   ' +
  '   #"""!###   ' +
  '   ######     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '  ######      ' +
  '  #!!!!#      ' +
  '  #!!"%#####  ' +
  '  ##&"%!!!!#  ' +
  '   #$"%#!!!#  ' +
  '   ##!!#####  ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #######   ' +
  '   ##!"!!!#   ' +
  '   #!%&%#!#   ' +
  '   #!#$!!!#   ' +
  '   #!!"!###   ' +
  '   ######     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   #######    ' +
  '  ##""""$##   ' +
  '  #!!%!#%!#   ' +
  '  #!!%!!%!#   ' +
  '  #!!##!!!#   ' +
  '  #########   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '      ####    ' +
  '   ####!$#    ' +
  '   #!!%%!#    ' +
  '   #!"!%!#    ' +
  '   ##""!##    ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   ########   ' +
  '   #!"$"!!#   ' +
  '   #!%!%!!#   ' +
  '   ##&#&###   ' +
  '   #!!!!!#    ' +
  '   #!!!!!#    ' +
  '   #!!####    ' +
  '   ####       ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   #######    ' +
  '   #!"!!!#    ' +
  '   #!!%""#    ' +
  '   ###%&###   ' +
  '   #!%$!!!#   ' +
  '   #!!!!!!#   ' +
  '   ########   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     ####     ' +
  '   ###!!#     ' +
  '   #!!!!##    ' +
  '   #!#!""#    ' +
  '   #!%%%$#    ' +
  '   ###!#!#    ' +
  '     #!!"#    ' +
  '     #####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     #####    ' +
  '   ###!!!#    ' +
  '   #!%%%$#    ' +
  '   #"""!##    ' +
  '   #!!!!#     ' +
  '   ######     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     #####    ' +
  '    ##!!!#    ' +
  '    #!$!!#    ' +
  '   ##!%!##    ' +
  '   #!%&!#     ' +
  '   #!#"!#     ' +
  '   #!!"##     ' +
  '   #####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     ####     ' +
  '     #!!#     ' +
  '   ###%!##    ' +
  '   #!!%!!#    ' +
  '   #$#&"!##   ' +
  '   #!!&"!!#   ' +
  '   ###!!!!#   ' +
  '     ######   ' +
  '              ' +
  '              ' +
  '              ' +
  '      #####   ' +
  '    ###$!!#   ' +
  '    #"!%!"#   ' +
  '    #!!%!##   ' +
  '   ###!###    ' +
  '  ##!%!!#     ' +
  '  #!!!!!#     ' +
  '  #"!!###     ' +
  '  #####       ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!##     ' +
  '    #$"!#     ' +
  '    #""%##    ' +
  '    #!%%!#    ' +
  '    #!!!!#    ' +
  '    ######    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '     ####     ' +
  '     #!!###   ' +
  '   ###!"!!#   ' +
  '   #$%%%!!#   ' +
  '   #!!!#"!#   ' +
  '   ###"!!##   ' +
  '     #####    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    ####      ' +
  '    #!!#      ' +
  '    #!!####   ' +
  '    #!""&!#   ' +
  '   ##!%%$!#   ' +
  '   #!!!####   ' +
  '   #!!!#      ' +
  '   #####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '  #####       ' +
  '  #!!!###     ' +
  '  #!!"%!###   ' +
  '  ##!"#!%!#   ' +
  '   #!"#!%$#   ' +
  '   ##"!!%!#   ' +
  '    #!!####   ' +
  '    ####      ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '  ####        ' +
  '  #!!#####    ' +
  '  #!!!!$!##   ' +
  '  #!"&"%&!#   ' +
  '  ##!!#%!!#   ' +
  '   ##!!!###   ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '      ####    ' +
  '  #####!!#    ' +
  '  #!!!""%##   ' +
  '  #!%$#!%!#   ' +
  '  ##%""!!!#   ' +
  '   #!!##!!#   ' +
  '   ########   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '    #!!!#     ' +
  '    #!#%##    ' +
  '   ##""$!#    ' +
  '   #!&"%!#    ' +
  '   #!#!%##    ' +
  '   #!!!!#     ' +
  '   ######     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '  ###         ' +
  '  #"#####     ' +
  '  #"""!!#     ' +
  '  #!#!#!###   ' +
  '  #!!!%%!$#   ' +
  '  ###!!%%!#   ' +
  '    ###!!!#   ' +
  '      #####   ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '   ########   ' +
  '   #!!##!"#   ' +
  '  ##!!!%!!#   ' +
  '  #!!%#%!"#   ' +
  '  #!!!#$!##   ' +
  '  #"!##!!#    ' +
  '  ########    ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '    #####     ' +
  '    #!!!#     ' +
  '   ##!!!###   ' +
  '   #!%%%%!#   ' +
  '   #!""""!#   ' +
  '   ##!$!###   ' +
  '    #####     ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '              ' +
  '  ########    ' +
  '  #""!$""#    ' +
  '  #!!%%%!#    ' +
  '  ####!####   ' +
  '  #!!!!!!!#   ' +
  '  #!!!!!%!#   ' +
  '  #!!######   ' +
  '  ####        ' +
  '              ' +
  '              '

IMAGE_DATA =
  '     !!!!!"     ' +
  '     !"!"!"     ' +
  '     !!!!!"     ' +
  '     !"""!"     ' +
  '     !!!!!"     ' +
  '     """"""     ' +
  '  !"!!!!!!!"!"  ' +
  '  !"!!!!!!!"!"  ' +
  '  !"!"""""!"!"  ' +
  '  !"!"""""!"!"  ' +
  '  ""!!!!!!!"""  ' +
  '    """"""""    ' +
  '     !"  !"     ' +
  '     !"  !"     ' +
  '   !!!"  !!!"   ' +
  '   """"  """"   ' +
  '               "' +
  ' !!""!!!!!!""!!"' +
  ' !!  !!!!!!  !!"' +
  '""""""""""""""""' +
  '   "   "   "   "' +
  ' !!" !!" !!" !!"' +
  ' !!" !!" !!" !!"' +
  ' !!" !!" !!" !!"' +
  ' !!" !!" !!" !!"' +
  ' !!" !!" !!" !!"' +
  ' !!" !!" !!" !!"' +
  '""""""""""""""""' +
  '               "' +
  ' !!""!!!!!!""!!"' +
  ' !!  !!!!!!  !!"' +
  '""""""""""""""""' +
  '        !!!!!!!!' +
  ' """""" !      !' +
  ' """""" !      !' +
  ' """""" !      !' +
  ' """""" !      !' +
  ' """""" !      !' +
  ' """""" !      !' +
  '        !!!!!!!!' +
  '!!!!!!!!        ' +
  '!      ! """""" ' +
  '!      ! """""" ' +
  '!      ! """""" ' +
  '!      ! """""" ' +
  '!      ! """""" ' +
  '!      ! """""" ' +
  '!!!!!!!!        ' +
  ' !!!!!!!!!  !!! ' +
  '!!!       "!!! "' +
  '!!       ""!!  "' +
  '!       """!   "' +
  ' """"""""" !   "' +
  ' !!!  !!!! !   "' +
  '!!! "!!!  "!   "' +
  '!!  "!!   "!   "' +
  '!   "!   ""!  ""' +
  '!   "!  """! """' +
  '!   " """"  """ ' +
  '!   " !!!!!!!!! ' +
  '!   "!!!       "' +
  '!  ""!!       ""' +
  '! """!       """' +
  ' """  """"""""" '

# input: ascii string (0x20-0x26: data, >= 0x27: repetition marker)
def rle_compress(input)
  shift = 0x20
  compressed = ''
  char_array = (input + '/').split('')
  init = char_array[0]
  chars = []
  char_array.each do |c|
    if (c == init && chars.size() <= 88)
      chars.push(c)
    else
      if (chars.size() > 2)
        compressed << ((chars.size() + shift + 5).chr) << (chars[0])
      else
        chars.each do |ch|
          compressed << ch
        end
      end
      chars = []
      init = c
      chars.push(c)
    end
  end
  return compressed
end

def rle_decompress(input)
  decompressed = ''
  repeat = 1
  input.split('').each do |c|
    if (c.ord >= 0x27)
      repeat = c.ord - 0x25
    else
      (0 ... repeat).to_a.each do |i|
        decompressed << c
      end
      repeat = 1
    end
  end
  return decompressed
end

def decompress(input, rle = true)
  entries = input.split('|')
  decompressed = entries.shift
  (0 ... entries.size).step(2).to_a.each do |i|
    decompressed.gsub!(entries[i], entries[i + 1])
  end
  return rle ? rle_decompress(decompressed) : decompressed
end

# replace the most frequent words with substitution characters
def greedy_compress(input, rle = true)
  data = rle ? rle_compress(input) : input
  unused_chars = []
  # these must be safe for RegExp point of view
  subst_characters = ['_', ',', '=', '@'].
    concat(('0' .. '9').to_a).
    concat(('a' .. 'z').to_a).
    concat(('A' .. 'Z').to_a)
  subst_characters.each do |char|
    unused_chars.push(char) if !data.include?(char)
  end
  dictionary = {}
  subst_map = {}
  (3 .. 10).to_a.reverse.each do |word_length|
    word_count = {}
    data.scan(Regexp.new(".{#{word_length}}")).each do |word|
      word_count[word] = 0 if word_count[word].nil?
      word_count[word] += 1
    end
    word_count.each do |word, count|
      if count > 2
        length = word.size * count
        dictionary[length] = [] if dictionary[length].nil?
        dictionary[length].push(word)
      end
    end
  end
  compressed = data.clone
  dictionary.sort.reverse.each do |length, words|
    words.each do |word|
      next if !compressed.include?(word) || unused_chars.empty?
      subst = unused_chars.shift
      compressed.gsub!(word, subst)
      subst_map[subst] = word
    end
  end
  subst_map.each do |char, word|
    compressed << "|#{char}|#{word}"
  end
  return compressed
end

def test(name, data, rle = true)
  compressed = greedy_compress(data, rle)
  decompressed = decompress(compressed, rle)
  puts "================================================="
  puts name
  puts "-------------------------------------------------"
  puts "input data size .... [#{data.size}]"
  puts "compressed size .... [#{compressed.size}]"
  puts "compression ratio .. [#{sprintf('%.2f%', compressed.size.to_f / data.size.to_f)}]"
  puts "decomp. valid ...... [#{data == decompressed}]"
  puts "-------------------------------------------------"
  puts "compressed = '#{compressed}';"
  puts "================================================="
  puts
end

test("levels", LEVEL_DATA)
test("images", IMAGE_DATA)
