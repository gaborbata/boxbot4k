<!DOCTYPE html>
<html>
  <head>
    <title>BoxBot</title>
    <script type="text/javascript">
      var W = 14,
          H = 12,
          R = 'rgba(0,0,0,0)',
          Q = 'rgba(0,0,0,0.3)',
          P = [
            ['#21285c','#19204c','#303378',2],['#5c3c20','#4c3018','#785830',2],['#74060c','#640305','#8e1618',2],
            ['#a29b79','#cec491','#7f7543',3],[R,'#c0c0c0','#808080',0],['#c4a864','#a88448','#6f4e2a',1],
            ['#c47865','#a85449','#6f2c2b',1],[R,Q,Q,0],
            [Q,Q,Q,1]
          ],
          C = W * 16,
          z, t, w, m, h, f, v, u, q, b;

      function g(k, x, o) {
          var r = 1,
              d = 0,
              s = 0,
              c;
          for (var j = 0; j < k.length; j++) {
              c = k.charCodeAt(j);
              if (c >= 0x27) {
                  r = c - 0x25;
              } else {
                  for (var i = 0; i < r; i++) {
                      if (d >= x * o.length && s < o.length) {
                          o[s++] = c - 0x20;
                      }
                      d++;
                  }
                  r = 1;
              }
          }
      }

      function l() {
          if (v < 0) {
              v = 50 - 1;
          } else if (v > 50 - 1) {
              v = 0;
          }
          m = 0;
          h = 0;
          f = false;
          g('R )#/ #"!#/ #!!*#+ #%!!%!!#+ #!$(!"#+ -#~   )#/ #!!(#- #!!%$#- #!&"!#- ##(!#. *#e )#/ #!!#' +
            '/ #!!(#- #!!%!#- ##&#"#- #!!$!#- #)!#- #!!(#- )#g )#/ #!!#/ #!!#/ #!$(#- #!%%!#- #"!!"#- +' +
            '#s *#. #(!#. #"#%##- #!!$!#- #"!%!#- (#!!#/ )#~   -#+ #+!#+ #!"&&%$#+ #+!#+ *#!!#/ )#t )#-' +
            ' (#!!#- #"%%"#- #!#!!#- #!$!!#- (#!!#/ )#f )#- (#!!#- #)!#- #(!"(#+ (#!#$"#- #!%%!#- #!!%!' +
            '#- #"!(#- )#f +#, ##)!#, #!%##!##+ #+!#+ ##!!"$"#, #%#!(#, #(!#. *#f )#. ##!!)#+ #+!#+ #!"' +
            '"#%!#+ (#!!%!#- (#$!#/ )#f *#. #(!#* *#!#!##) #!!#!%(!#) #(!%!!#!#) #!""!#(!#) (#$!*#+ #!!' +
            '#/ )#g *#. #(!(#* (#$%"!!#* #!!&#(!#* #(!%"!##* *#!!#/ )#r )#/ #!!)#, #!"(!#, #!$%%!#, ##!' +
            '!(#- #"!#/ #!!#/ )#g *#- ##!!"#- #!%#"#- #)!##, ##!#!!#- #%!$!#- #(!##- *#h *#. #(!#+ )#(!' +
            '#+ #"&(!##+ #!%#!!#, #$!#!!#, ,#s )#/ #"$#/ #!!(#- #!%!!#- #!%"!#- #!!(#- )#v *#, (#(!#, #' +
            '!%!#!##+ #!#!!"!#+ #!"!!#!#+ ##%#"%!#, #$!!(#, *#f ,#, #)!"#, #!(#"#+ ##!#(!#+ #!!#!%!#+ #' +
            '!!$!%##+ #!!#!!#, ,#e )#- (#!!)#* #)!#$"#* #)!%%"#* #!!##!%"#* *#(!#. *#r *#. #!$!(#, #!#(' +
            '!#+ ##%"&#!#+ #!%"&!!#+ #!#!!(#+ #)!#- +#W )#/ #!!#/ #%$#/ #"%(#, ##"%!!##+ #!"#(!##* #,!#' +
            '* *#(!#. *#U )#/ #!!(#- #!$!!#- #"!#%##, ##"%!!#, #!%"#!#, #!#(!#, #)!##, (#!!#/ )#W ,#+ #' +
            '#!!#!!(#) #!%!#!%!!#) #!!"$"(!#) ##%!#!%(#* #!"!"!#, ,#~   )#/ #!!*#+ #!!"&"!#+ #!%!%!$#+ ' +
            '#(!)#+ *#t ,#, #"!"!"#, #(!#!#, ##!!%!#- #!%%##- #!!$#. *#t )#/ #!!##- ##(!##, #!$%%!#, #!' +
            '#!#!#, #""(!#, ,#t )#/ #!"#- (#!!##, #!%%!!#, #*!#, ##%#!##- #"$"#. *#g *#. #(!#, (#%#!##+' +
            ' #!!%$%!#+ #!#)!#+ #("!(#+ +#r +#- #)!#- #!!"%*#) ##&"%)!#* #$"%#(!#* ##!!*#+ )#~ * ,#+ ##' +
            '!"(!#+ #!%&%#!#+ #!#$(!#+ #!!"!(#+ +#~ ( ,#+ ##)"$##* #!!%!#%!#* #!!%!!%!#* #!!##(!#* .#~ ' +
            ') )#, )#!$#, #!!%%!#, #!"!%!#, ##""!##- *#s -#+ #!"$"!!#+ #!%!%!!#+ ##&#&(#+ #*!#, #*!#, #' +
            '!!)#, )#g ,#, #!"(!#, #!!%""#, (#%&(#+ #!%$(!#+ #+!#+ -#s )#- (#!!#- #)!##, #!#!""#, #!(%$' +
            '#, (#!#!#. #!!"#. *#t *#, (#(!#, #!(%$#, #("!##, #)!#- +#u *#- ##(!#- #!$!!#, ##!%!##, #!%' +
            '&!#- #!#"!#- #!!"##- *#h )#/ #!!#- (#%!##, #!!%!!#, #$#&"!##+ #!!&"!!#+ (#)!#- +#X *#, (#$' +
            '!!#, #"!%!"#, #!!%!##+ (#!(#+ ##!%!!#, #*!#, #"!!(#, *#h )#/ #!!##. #$"!#. #""%##- #!%%!#-' +
            ' #)!#- +#t )#/ #!!(#+ (#!"!!#+ #$(%!!#+ #(!#"!#+ (#"!!##- *#s )#/ #!!#/ #!!)#, #!""&!#+ ##' +
            '!%%$!#+ #(!)#+ #(!#. *#e *#. #(!(#, #!!"%!(#* ##!"#!%!#+ #!"#!%$#+ ##"!!%!#, #!!)#, )#e )#' +
            '/ #!!*#+ #)!$!##* #!"&"%&!#* ##!!#%!!#+ ##(!(#, *#v )#+ *#!!#+ #(!""%##* #!%$#!%!#* ##%""(' +
            '!#+ #!!##!!#+ -#r *#. #(!#. #!#%##, ##""$!#, #!&"%!#, #!#!%##, #)!#- +#d (#0 #"*#, #("!!#,' +
            ' #!#!#!(#* #(!%%!$#* (#!!%%!#, (#(!#. *#c -#+ #!!##!"#* ##(!%!!#* #!!%#%!"#* #(!#$!##* #"!' +
            '##!!#+ -#s *#. #(!#- ##(!(#+ #!)%!#+ #!)"!#+ ##!$!(#, *#r -#+ #""!$""#+ #!!(%!#+ )#!)#* #,' +
            '!#* #*!%!#* #!!+#* )#I ', v, t);
          for (var x = 0; x < W; x++) {
              for (var y = 0; y < H; y++) {
                  if (t[W * y + x] == 4) {
                      t[W * y + x] = 1;
                      u.x = x;
                      u.y = y;
                  }
              }
          }
      }

      function p() {
          for (var i = 0; i < 3; i++) {
              for (var x = 0; x < W; x++) {
                  for (var y = 0; y < H; y++) {
                      if (!q) {
                          w.drawImage(z[0], x * 32, y * 32);
                      } else if (i == 0 && t[W * y + x] <= 2) {
                          w.drawImage(z[t[W * y + x]], x * 32, y * 32);
                      } else if (i == 1 && t[W * y + x] > 2) {
                          w.drawImage(z[8], x * 32 + 4, y * 32 + 4);
                      } else if (i == 2 && t[W * y + x] > 2) {
                          w.drawImage(z[t[W * y + x]], x * 32, y * 32);
                      }
                  }
              }
              if (i == 1 && q) {
                  w.drawImage(z[7], u.x * 32 + 4, u.y * 32 + 4);
              } else if (i == 2 && q) {
                  w.drawImage(z[4], u.x * 32, u.y * 32);
              }
          }
          w.font = 'bold 14px sans-serif';
          w.fillStyle = 'rgba(255,255,255,0.4)';
          w.textAlign = 'center';
          if (!q) {
              w.fillText('BOXBOT', C, 125);
              w.fillText('GAME CONTROLS:', C, 163);
              w.fillText('ARROW KEYS - MOVE', C, 182);
              w.fillText('BACKSPACE - RESTART LEVEL', C, 201);
              w.fillText('PGUP/PGDN - NEXT/PREVIOUS LEVEL', C, 220);
              w.fillText('PRESS ANY KEY TO START.', C, 258);
              w.fillText('(C) 2014 GABOR BATA', C, 376);
          } else {
              if (f) {
                  w.fillText('LEVEL COMPLETED! PRESS ENTER TO CONTINUE.', C, 19);
              }
              w.fillText('LEVEL: ' + (v + 1) + '     MOVES: ' + m + '     PUSHES: ' + h, C, 376);
          }
      }

      function init() {
          var a = document.getElementById('b');
          if (a != null && !!a.getContext) {
              w = a.getContext('2d');
              z = new Array(P.length);
              var r = new Array(256);
              for (var i = 0; i < z.length; i++) {
                  g('* *!"/ !"!"!"/ *!"/ !("!"/ *!"/ +", !",!"!") !",!"!") !"!*"!"!") !"!*"!"!") "",!("+ -". !"' +
                    '  !"/ !"  !"- (!"  (!"+ )"  )"7 " !!""+!""!!" !!  +!  !!6"( "( "( "( " !!" !!" !!" !!" !!"' +
                    ' !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!" !!6"4 " !!""+!""!' +
                    '!" !!  +!  !!6"- -! +" !+ ! +" !+ ! +" !+ ! +" !+ ! +" !+ ! +" !+ !- 5!- !+ ! +" !+ ! +" !' +
                    '+ ! +" !+ ! +" !+ ! +" !+ ! +" -!. .!  (! (!, "(! "!!, ""!!  "!, ("!( " ." !( " (!  )! !( ' +
                    '"(! "(!  "!( "!!  "!!( "!( "!( "!( ""!  ""!( "!  ("! ("!( " )"  (" !( " .! !( "(!, "!  ""!' +
                    '!, ""! ("!, (" ("  ." ', P[i][3], r);
                  var e = document.createElement('canvas');
                  e.width = 32;
                  e.height = 32;
                  var s = e.getContext('2d');
                  s.clearRect(0, 0, 32, 32);
                  for (var x = 0; x < 16; x++) {
                      for (var y = 0; y < 16; y++) {
                          s.fillStyle = P[i][r[16 * y + x]];
                          s.fillRect(x * 2, y * 2, 2, 2);
                      }
                  }
                  z[i] = e;
              }
              t = new Array(W * H);
              v = 0;
              u = { x: 0, y: 0 };
              q = false;
              b = false;
              l();
              p();
              window.addEventListener('keydown', function(e) {
                  e.preventDefault();
                  if (!b) {
                      b = true;
                      if (q) {
                          var d = { x: 0, y: 0 };
                          switch (e.keyCode) {
                              case 38:
                                  d.y = -1;
                                  break;
                              case 40:
                                  d.y = 1;
                                  break;
                              case 37:
                                  d.x = -1;
                                  break;
                              case 39:
                                  d.x = 1;
                                  break;
                              case 33:
                                  v++;
                                  l();
                                  break;
                              case 34:
                                  v--;
                                  l();
                                  break;
                              case 8:
                                  l();
                                  break;
                              case 13:
                                  if (f) {
                                      v++;
                                      l();
                                  }
                                  break;
                              default:
                                  return;
                          }
                          if ((d.x != 0 || d.y != 0) && !f) {
                              var s = W * (u.y + d.y) + u.x + d.x;
                              var n = W * (u.y + d.y * 2) + u.x + d.x * 2;
                              if (t[s] == 1 || t[s] == 2) {
                                  u.x += d.x;
                                  u.y += d.y;
                                  m++;
                              } else if ((t[s] == 5 || t[s] == 6) && (t[n] == 1 || t[n] == 2)) {
                                  t[s] = t[s] == 5 ? 1 : 2;
                                  t[n] = t[n] == 1 ? 5 : 6;
                                  u.x += d.x;
                                  u.y += d.y;
                                  m++;
                                  h++;
                              }
                              n = true;
                              for (var i = 0; i < t.length; i++) {
                                  if (t[i] == 5) {
                                      n = false;
                                  }
                              }
                              f = n;
                          }
                      } else {
                          q = true;
                      }
                      p();
                  }
              }, false);
              window.addEventListener('keyup', function() {
                  b = false;
              }, false);
          } else {
              document.body.appendChild(document.createTextNode('Could not initialize game.'));
          }
      }
    </script>
    <style type="text/css">
      body {
        background-color: #000;
        color: #fff;
        margin: 0
      }
      #w {
        display: table;
        position: absolute;
        height: 100%;
        width: 100%
      }
      #c {
        display: table-cell;
        vertical-align: middle
      }
      #b {
        display: block;
        height: 384px;
        margin: 0 auto;
        width: 448px
      }
    </style>
  </head>
  <body onload="init();">
    <div id="w">
      <div id="c">
        <canvas id="b" width="448" height="384"></canvas>
      </div>
    </div>
  </body>
</html>
